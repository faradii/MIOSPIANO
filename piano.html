<!DOCTYPE html>
<html lang="de">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MIOS PIANO</title>
<style>
html, body {
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background: grey;
  display:flex;
  flex-direction:column;
}

#controls {
  width:100%;
  padding:5px;
  text-align:center;
  background:#ccc;
  z-index:3;
}

.Spielfeld {

  flex:1;
  display:flex;
  justify-content:flex-start;
  align-items:flex-end;
  position:relative;
  overflow-x:auto;
  padding:0;
  margin:0;
}

.TasteBlock {
  position: relative;
  flex-shrink:0;
}

.weiss {
  width:90px;
  height:100vh;
  background:#eee;
  border:1px solid black;
  text-align:center;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  font-weight:bold;
  font-size:16px;
  box-sizing:border-box;
}

.schwarz {
  width:60px;
  height:60%;
  background:black;
  position:absolute;
  top:0;
  left:60px; /* halb über der weißen Taste */
  z-index:2;
  color:white;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  font-size:14px;
  box-sizing:border-box;
}

.active {
  background: orange !important;
}



</style>
</head>
<title> MIOS PIANO</title>
<body>
<div id="controls">
  <button id="freeBtn">Freies Spiel</button>

  <select id="lessonSelect">
    <option value="">Lektion wählen</option>
    <option value="lesson1">Entchen</option>
    <option value="lesson2">Conan</option>
 	<option value="lesson3">Mars</option>
   </select>
</div>

<div class="Spielfeld">

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="C">C</div>
    <div class="Taste schwarz" data-note="C#">C#</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="D">D</div>
    <div class="Taste schwarz" data-note="D#">D#</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="E">E</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="F">F</div>
    <div class="Taste schwarz" data-note="F#">F#</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="G">G</div>
    <div class="Taste schwarz" data-note="G#">G#</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="A">A</div>
    <div class="Taste schwarz" data-note="A#">A#</div>
  </div>

  <div class="TasteBlock">
    <div class="Taste weiss" data-note="H">H</div>
  </div>

</div>



<script >
/*
src="piano.js"
const tasten = document.querySelectorAll(".Taste");

tasten.forEach(taste => {
  taste.addEventListener("click", () => {
    const note = taste.dataset.note;
    const audio = new Audio(note + ".mp3");
    audio.play();
  });
});
*/

const lessons = {
  lesson1: ["C", "D", "E","F","G","G","A","A","A","A","G","A","A","A","A","G","F","F","F","F","E","E","D","D","D","D","C"],
  lesson2: ["F", "E", "D","A","F", "E", "D","A#","A","G","F","G","F","G","A","F","E","D","G","F","E","D","E","F","D","A","F","G","A#","A","G","A"],
  lesson3: ["F#", "F#","A","F#","A","F#","G#","G#","A","H","E","G#","H","G#","F#"]
};

let mode = "free";       // "free" oder "learn"
let currentLesson = [];
let currentStep = 0;

document.getElementById("freeBtn").onclick = () => {
  mode = "free";
  clearHighlights();
};

document.getElementById("lessonSelect").onchange = e => {
  const key = e.target.value;
  if (!key) return;

  mode = "learn";
  currentLesson = lessons[key];
  currentStep = 0;

  highlight(currentLesson[currentStep]);
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

const frequenzen = {
  C: 261.63,
  "C#": 277.18,
  D: 293.66,
  "D#": 311.13,
  E: 329.63,
  F: 349.23,
  "F#": 369.99,
  G: 392.00,
  "G#": 415.30,
  A: 440.00,
  "A#": 466.16,
  H: 493.88
};
function clearHighlights() {
  document.querySelectorAll(".Taste").forEach(taste => {
    taste.classList.remove("active");
  });
}

function highlight(note) {
  clearHighlights();
  const taste = document.querySelector(`[data-note="${note}"]`);
  if (taste) {
    taste.classList.add("active");
  }
}


function spieleTon(note) {
  const oscillator = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  //oscillator.type = "sine"; // reine Schwingung
  oscillator.type = "square";
  //oscillator.type = "sawtooth"; // aggressiver
  oscillator.frequency.value = frequenzen[note];

  oscillator.connect(gain);
  gain.connect(audioCtx.destination);

  oscillator.start();
  gain.gain.exponentialRampToValueAtTime(
    0.001,
    audioCtx.currentTime + 1
  );

  oscillator.stop(audioCtx.currentTime + 1);
}

/*document.querySelectorAll(".Taste").forEach(taste => {
  taste.addEventListener("click", () => {
    spieleTon(taste.dataset.note);
  });
});

document.querySelectorAll(".Taste").forEach(taste => {
  taste.addEventListener("click", () => {
    const note = taste.dataset.note;

    if (mode === "free") {
      spieleTon(note);
      return;
    }

    if (mode === "learn") {
      const erwartet = currentLesson[currentStep];

      if (note === erwartet) {
        spieleTon(note);
        currentStep++;

        if (currentStep < currentLesson.length) {
          highlight(currentLesson[currentStep]);
        } else {
          clearHighlights();	
          mode="free"
        }
      }
    }
  });
  
});
  */

document.querySelectorAll(".Taste").forEach(taste => {
  taste.addEventListener("click", handleTaste);
  taste.addEventListener("touchstart", handleTaste);
});

function handleTaste(e) {
  e.preventDefault(); // verhindert doppelten Event auf Mobil
  const note = e.currentTarget.dataset.note;

  if (mode === "free") {
    spieleTon(note);
    return;
  }

  if (mode === "learn") {
    const erwartet = currentLesson[currentStep];

    if (note === erwartet) {
    
      spieleTon(note);
      currentStep++;

      if (currentStep < currentLesson.length) {
        highlight(currentLesson[currentStep]);
      } else {
        clearHighlights();
        // Hier: Loop der Lektion, damit es sofort wieder beginnt
        currentStep = 0;
        highlight(currentLesson[currentStep]);
      }
    }
  }
}


</script>
</body>
</html>

